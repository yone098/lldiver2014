<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Hack LL Diver</title>

    <meta name="description" content="A framework for easily creating beautiful presentations using HTML">
    <meta name="author" content="Hakim El Hattab">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="css/theme/default.css" id="theme">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', include the PDF print sheet -->
    <script>
      if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = 'css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
      }
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="reveal">
      <div class="slides">
      <section data-markdown
           data-separator="\n---\n$"
           data-vertical="\n--\n"
          data-charset-"UTF-8">
          <script type="text/template">
<!-- .slide: data-background="img/hack.png" data-background-size="300px" data-background-position="top left" -->

# __Hack__
## 　
### LL Diver
帰ったきただめ自慢

2014/08/23
<!-- .slide: class="center" -->

---

## About Me

### 米林 正明
#### @yone098
#### 株式会社Abby CEO
### 　
<img src="img/hack.jpg" width="166" height="240"/>
<img src="img/docker.jpg" width="166" height="240"/>
<img src="img/java.jpg" width="166" height="240"/>
---

## About Me

### 米林 正明
#### @yone098
#### 株式会社Abby CEO
#### <font color='#FE2EC8'>__社員募集中！__</font>
<img src="img/hack.jpg" width="166" height="240"/>
<img src="img/docker.jpg" width="166" height="240"/>
<img src="img/java.jpg" width="166" height="240"/>
---

## __Agenda__
　
　

- Hack
- HHVM
- Hack Features
- DAME JIMAN


---

## __Hack__
<!-- .slide: data-background="img/hack.png" data-background-size="300px" data-background-position="top right" -->


---

## __Hack__
<!-- .slide: data-background="img/hack.png" data-background-size="300px" data-background-position="top right" -->

- HackとはFacebookがリリースしたPHPと互換性を持つHHVM(Hip Hop Virtual Machine for PHP)
向けの開発言語
 - http://hacklang.org/
- Facebookのサイトは2013年以降PHPからHackへ移行
 - Facebookでの実績
- 特長
 - Nullable, Generics, etc...

### 　
　 　
---

## __Hack__
<!-- .slide: data-background="img/hack.png" data-background-size="300px" data-background-position="top right" -->

- HackとはFacebookがリリースしたPHPと互換性を持つHHVM(Hip Hop Virtual Machine for PHP)
向けの開発言語
 - http://hacklang.org/
- Facebookのサイトは2013年以降PHPからHackへ移行
 - Facebookでの実績
- 特長
 - Nullable, Generics, etc...

### <b><font color='#FE2EC8'>Summary</b>
- <b><font color='#FE2EC8'>PHPの代替になる新しいプログラミング言語</b>


---

## __HHVM__
<!-- .slide: data-background="img/hhvm.png" data-background-size="300px" data-background-position="top right" -->


---

## __HHVM__
<!-- .slide: data-background="img/hhvm.png" data-background-size="300px" data-background-position="top right" -->

- HHVM(HipHop Virtual Machine)とはFacebookが開発・公開しているC++で実装されたJITコンパイラPHP実行環境
 - JITコンパイル -> 高速動作
 - Hackを動作させる唯一のVM
 - FastCGIインターフェース仕様でnginx, Apacheと動作
 - http://hhvm.org/
   - 最新 version (2014/08/22現在)

```
$ hhvm --version
HipHop VM 3.2.0-dev (rel)
```

### 　



---

## __HHVM__
<!-- .slide: data-background="img/hhvm.png" data-background-size="300px" data-background-position="top right" -->

- HHVM(HipHop Virtual Machine)とはFacebookが開発・公開しているC++で実装されたJITコンパイラPHP実行環境
 - JITコンパイル -> 高速動作
 - Hackを動作させる唯一のVM
 - FastCGIインターフェース仕様でnginx, Apacheと動作
 - http://hhvm.org/
    - 最新 version (2014/08/22現在)

```
$ hhvm --version
HipHop VM 3.2.0-dev (rel)
```

### <b><font color='#FE2EC8'>Summary</b>
- <b><font color='#FE2EC8'>PHPとHackを動作させるVM</font></b>


---

## __Hack Features__



---

## __Hack Features__
<!-- .slide: data-background="img/hack.png" data-background-size="300px" data-background-position="top right" -->

- 概要説明
 - Type Annotations
 - Nullable
 - Generics
 - Collection
 - Type Aliasing
 - Variable Number of Arguments


---

## __Hack Features__
<!-- .slide: data-background="img/hack.png" data-background-size="300px" data-background-position="top right" -->

- Type Annotations
 - 静的型付けがあり関数の引数や戻り値に明示的に型を宣言することが可能

```php
class AnnotatedClass {
  public int $i = 10;
  private string $str = "STRING";
  protected array $arr = array(1, 2);
}

function return_int_func(bool $flg): int {
  return 100;
}
```

---

## __Hack Features__
<!-- .slide: data-background="img/hack.png" data-background-size="300px" data-background-position="top right" -->

- Nullable
 - null を許容するかどうかを?で指定可能

```php
function nullable_arg_func(?string $name) : string {
  if ($name === null) return "name is null";
  return "Hello " . $name;
}

function null_ng_arg_func(string $name) : string {
  return "Hello " . $name;
}

nullable_arg_func(null);

null_ng_arg_func(null); // エラー発生
```

実行結果
```
$ hhvm examples.php

Fatal error: Argument 1 passed to null_ng_arg_func() must be an instance of string,
  null given in /home/yone098/examples.php on line 10
```

---

## __Hack Features__
<!-- .slide: data-background="img/hack.png" data-background-size="300px" data-background-position="top right" -->

- Generics
 - C++, Java, C# のような Genrics が利用可能

```php
class Dog<T> {
  private ?T $name;
  public function __construct(T $name) {
    $this->name = $name;
  }
  public function get_name() : T {
    return $this->name;
  }
}
$dog = new Dog("garsue");
echo("dog->get_name()=" . $dog->get_name() . "\n");

$map = Map<string, int> { "a" => 1, "b" => 2 };
var_dump($map);
```

実行結果
```
dog->get_name=garsue
object(HH\Map)#2 (2) {
  ["a"]=> int(1)
  ["b"]=>int(2)}
```

---

## __Hack Features__
<!-- .slide: data-background="img/hack.png" data-background-size="300px" data-background-position="top right" -->

- Collections
 - Hackでは Vector，Map，Set，PairというCollectionsが利用可能

```php
  $vector = Vector<int> { 100, 200, 300, 400 };
  $vector[] = 700; // 追加
  $vector[0] = 111; // 上書き

  $vector->removeKey(2);
  foreach ($vector as $v) { echo $v . "\n"; }

  $map = Map<string, long> {"a" => 100, "b" => 200, "c" => 300};
  $map["d"] = 400;
  echo "map->get(\"b\") = ". $map->get("b") . "\n";
  var_dump($map->contains("a"));
  // map filterWithKey
  $map_filter = $map->filterWithKey(function($k, $v) {
    return ($k === "b" || $k === "c");
  });
  var_dump($map_filter);
```

---

## __Hack Features__
<!-- .slide: data-background="img/hack.png" data-background-size="300px" data-background-position="top right" -->

- Type Aliasing
 - Hackでは，typeおよびnewtypeの宣言で既存の型に別名をつけることが可能。

```php
type user_id = int;

// 引数の型は user_id
function get_user_name(user_id $user_id): string {
    return "mopemope";
}

newtype password = string;
// 引数の型は password
function login(user_id $user_id,  password $password): bool {
    return true;
}
```

---

## __Hack Features__
<!-- .slide: data-background="img/hack.png" data-background-size="300px" data-background-position="top right" -->

- Variable Number of Arguments
 - Hack では可変長引数を `...` と明示的に指定可能

```php
function test_many_args(int $num, ...): void {
  echo "num:" . $num . "\n";
  foreach (func_get_args() as $e) {
    var_dump($e);
  }
}

test_many_args(100, "garsue", 1, array(), 3.14);
```

実行結果
```
num:100
int(100)
string(6) "garsue"
int(1)
array(0) {
}
object(Yone)#8 (0) {
}
float(3.14)
```

---

## __Tool__
- Debugger
 - デバッガー機能 (step実行等)
- hh_client
 - 実行前に静的型付けのチェック
- fastcgi
 - 設定・設定解除

---

## __Tool__

- Debugger
 - 起動：`hhvm -m debug ファイル名`
 - ブレークポイント：`break 関数名`
 - ステップ実行：`step`
 - 確認：`print 変数名`
 - 現在： *

```
Break at loop() on line 3 of /home/yone098/debug.php
   2 function loop() : void {
   3*  for ($i = 1; $i <= 3; $i++) {
   4     $sum += $i;

hphpd> print $sum
1
```

---

## __Tool__
- Debugger
 - variable (Web application)

```
hphpd> variable
$argv = Array()

$_FILES = Array()

$_SERVER = Array([XDG_SESSION_ID] => "4", [USER] => "yone098", [SSH_TTY] => ...

$_GET = Array()

$_COOKIE = Array()

$argc = 0

$_REQUEST = Array()

$_POST = Array()
```

---

## __Tool__

- hh_client
 - 実行前に静的型付けチェック
 - 指定フォルダに .hhconfig という空のファイルを置く
 - hh_client コマンドを実行

`.hhconfig` が無い場合

```
$ hh_client
Error: not a www tree (or any of the parent directories): /sample
```

---

## __Tool__
- hh_client
 - 不正な箇所がある場合に行番号と内容を表示

bad.php
```php
<?hh
function bad_func() : int {
  return "Hello, BpStudy#81";
}
bad_func();
```
　
実行結果

```
$ hh_client
/home/yone098/bad.php:3:10,28: Invalid return type
  /home/yone098/bad.php:2:23,25: This is an int
  /home/yone098/bad.php:3:10,28: It is incompatible with a string
```

- プロジェクトのルートフォルダに .hhconfig ファイルを設置しチェックを行うのがベスト

---

## __Tool__

- fastcgi
 - apache, nginx に対して fastcgi 設定を自動で行う
 - /usr/share/hhvm/install_fastcgi.sh
 - /usr/share/hhvm/uninstall_factcgi.sh

- apache, nginx をインストールしたあとにシェルを実行することですんなり HHVM が稼働します
- 当初は自前で設定する必要があったため即動かす事が容易ではなかった

---

## __Performance__


---

## __Performance__

`bench.php`

```php
<?php
function loop_test() {
  $sum = 0;
  for ($i = 0; $i < 1000000; $i++) {
    $sum += $i * 2;
  }
}

function main() {
  $startTime = microtime(true);
  loop_test();
  $endTime = microtime(true);
  echo $endTime - $startTime . "[sec]\n";
// 再度実行
}

main();
```


---

## __Performance__

- result
 - php : hhvm = 1 : 10

```
yone098@ubuntu-docker:~/work$ hhvm bench.php
0.012295007705688[sec]
0.010360956192017[sec]

yone098@ubuntu-docker:~/work$ hhvm bench.php
0.0089778900146484[sec]
0.011922836303711[sec]

yone098@ubuntu-docker:~/work$ php bench.php
0.10031509399414[sec]
0.098863124847412[sec]

yone098@ubuntu-docker:~/work$ php bench.php
0.09879994392395[sec]
0.099910974502563[sec]
```

---

## __Performance__

### wordpress ab

wordpress nginx + php-fpm

```
Requests per second:    19.53 [#/sec] (mean)
Time per request:       2560.771 [ms] (mean)
Time per request:       51.215 [ms] (mean, across all concurrent requests)
Transfer rate:          154.85 [Kbytes/sec] received
```

wordpress nginx + fastcgi + hhvm

```
Requests per second:    42.97 [#/sec] (mean)
Time per request:       1163.692 [ms] (mean)
Time per request:       23.274 [ms] (mean, across all concurrent requests)
Transfer rate:          340.33 [Kbytes/sec] received
```

---

## __HHVM Extensions__


---

## __HHVM Extensions__
- HHVMの拡張機能であり C++ の既存資産を生かす事が可能
- HNI (HHVM Native Interface) と呼ばれるHackの記法を使う
 - https://github.com/facebook/hhvm/wiki/Extension-API
- 必要ファイル
 - config.cmake
 - ext_hnifib.php (HNIで登録)
 - hnifib.cpp (HHVM_XX で登録)
 - build (hphpizeコマンド)
 - exec (-vDinamicExtensions.0=ライブラリ.so)
  - https://github.com/yone098/hhvm-extensions-examples
  - 本家のはそのままじゃ動かない
---


## __HHVM Extensions__

- config.cmake
  - 必要に応じて適宜ライブラリを追加

```make
HHVM_EXTENSION(hnifib hnifib.cpp)
HHVM_SYSTEMLIB(hnifib ext_hnifib.php)
```

　

- ext_sample.php
 - &lt;?hh で記述
 - &lt;&lt;__Native&gt;&gt; Attribute で登録

```php
<?hh
<<__Native>>
function hni_fib(int $n) : int;
```


---

## __HHVM Extensions__

- sample.cpp
 - HNI 用 include
 - HHVM_FUNCTION で定義, HHVM_FE で登録
 - Extension クラスを継承

```cpp
#include "hphp/runtime/base/base-includes.h"
namespace HPHP {
static int64_t HHVM_FUNCTION(hni_fib, int64_t n) {
  if (n <= 2) return 1;
  return HPHP::f_hni_fib(n - 2) + HPHP::f_hni_fib(n - 1);
}
static class HnifibExtension : public Extension {
 public:
  HnifibExtension() : Extension("hnifib") {}
  virtual void moduleInit() {
    HHVM_FE(hni_fib);
    loadSystemlib();
  }
} s_hnifib_extension;
HHVM_GET_MODULE(sample)
}
```

---

## __HHVM Extensions__

- build　　　　　　　　　　　　　　　　　　　　　　

```
hphpize
cmake .
make
```
　

- run　　　　　　　　　　　　　　　　　　　　　　
 - -vDynamicExtensions.0

```
hhvm \
  -vDynamicExtensions.0=${DIRNAME}/hnifib.so \
  ${DIRNAME}/app.php
```

---

## __HHVM Extensions__
- Performance

```php
<?php
function fib($n) {
  if ($n <= 2) return 1;
  return fib($n - 2) + fib($n - 1);
}
for ($i = 1; $i <= 20; $i++) echo(fib($i) . " ");
```

- result
 - HNI 速い！ &gt; hhvm &gt; php

```
$ php fib.php
1 1 2 3 5 8 13 21 34 55 89 144 233 377 610 987 1597 2584 4181 6765
0.013734102249146[sec]

$ hhvm fib.php
1 1 2 3 5 8 13 21 34 55 89 144 233 377 610 987 1597 2584 4181 6765
0.0083420276641846[sec]

$ ./run.sh
1 1 2 3 5 8 13 21 34 55 89 144 233 377 610 987 1597 2584 4181 6765
0.0031008720397949[sec]
```


---



# __DAME JIMAN__


---

# __だめ自慢__


- Hack はだめなところがない
 - 良い事ずくめ！
- 認知度が低い
 - VMが凄いのに知られてない
 - ３年後 HHVM がデファクト・スタンダード
 - もっとみんなで盛り上げましょう

---

# __一句__

---


# お台場で
# Hack 話して
# 四苦Hack(八苦)
<!-- .slide: data-background="img/basyou.jpg" data-background-size="300px" data-background-position="top right" -->

---

# __さいごに__

---

## ご招待頂いた法林さま
## ありがとうございました


---


<!-- .slide: data-background="img/fallinlove.jpg" data-background-size="600px" data-background-position="top" -->

          </script>
        </section>
    </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.min.js"></script>

    <script>

      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

        // Parallax scrolling
        // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
        // parallaxBackgroundSize: '2100px 900px',

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
          { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });

    </script>

  </body>
</html>
